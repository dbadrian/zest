#!/usr/bin/env bash
set -e

REPO=https://github.com/dbadrian/zest.git
APP_DIR=/home/zest/zest

# get the latest version of zest to get the tags
cd $APP_DIR/upstream
LATEST=$(git tag --list 'v*' --sort=-v:refname | head -n 1)

# now clone that specific tag again
cd $APP_DIR
git clone --branch $LATEST --depth 1 $REPO $APP_DIR/releases/$LATEST

# Symlink shared files like .env
echo "Link shared resources"
ln -sfn $APP_DIR/shared/.env.production $APP_DIR/releases/$LATEST/backend/.env.production
ln -sfn $APP_DIR/shared/logs $APP_DIR/releases/$LATEST/logs

# Setup and activate venv
echo "Create venv"
cd $APP_DIR/releases/$LATEST/backend
uv sync
source .venv/bin/activate

cd $APP_DIR/releases/$LATEST/backend
PYTHONPATH=. alembic upgrade head

echo "Switch current symlink"
ln -sfn $APP_DIR/releases/$RELEASE $APP_DIR/current

# echo "Graceful reload"
# sudo systemctl reload myapp